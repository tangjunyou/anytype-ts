# è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ anytype-ts é¡¹ç›®çš„ GitHub Actions å·¥ä½œæµ
name: Sync Upstream

# è§¦å‘æ¡ä»¶ï¼šæ¯å¤©å‡Œæ™¨ 2 ç‚¹è‡ªåŠ¨æ‰§è¡Œï¼Œæˆ–æ‰‹åŠ¨è§¦å‘
on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨ 2 ç‚¹
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Configure Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Add upstream remote
      run: |
        git remote add upstream https://github.com/anyproto/anytype-ts.git || true
        git fetch upstream
    
    - name: Sync main branch
      run: |
        git checkout main
        git merge upstream/main --no-edit
    
    - name: Push changes
      run: |
        git push origin main
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create Pull Request for conflicts
      if: failure()
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: sync upstream changes with conflicts'
        title: 'ğŸ”„ Upstream Sync - Manual Review Required'
        body: |
          ## ä¸Šæ¸¸åŒæ­¥å†²çª
          
          è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ `anyproto/anytype-ts` æ—¶é‡åˆ°å†²çªï¼Œéœ€è¦æ‰‹åŠ¨è§£å†³ã€‚
          
          ### å†²çªåŸå› 
          - æœ¬åœ°ä¿®æ”¹ä¸ä¸Šæ¸¸æ›´æ–°å­˜åœ¨å†²çª
          - éœ€è¦æ‰‹åŠ¨åˆå¹¶ä»£ç 
          
          ### è§£å†³æ­¥éª¤
          1. æ£€æŸ¥å†²çªæ–‡ä»¶
          2. æ‰‹åŠ¨è§£å†³å†²çª
          3. æµ‹è¯•åŠŸèƒ½å®Œæ•´æ€§
          4. åˆå¹¶æ­¤ PR
          
          **æ³¨æ„**: è¯·ç¡®ä¿æ‰©å±•åŠŸèƒ½ä¸å—å½±å“ã€‚
        branch: sync/upstream-conflicts
        delete-branch: true